# Interview Buddy CI/CD Pipeline
# Builds, tests, and deploys microservices with preview environments for feature branches

trigger:
  - main
  - feature/*
  - bugfix/*

pr:
  branches:
    include:
      - main

variables:
  acrName: 'ibdevacrpuj79a'
  acrLoginServer: 'ibdevacrpuj79a.azurecr.io'
  aksClusterName: 'letsfuckingsee'
  aksResourceGroup: 'interview-buddy-dev'
  azureSubscription: 'devops'

stages:
  # ========== TEST (Parallel Jobs) ==========
  - stage: Test
    displayName: 'Test'
    jobs:
      # Job 1: Lint (runs in parallel)
      - job: Lint
        displayName: 'ESLint'
        pool: macos
        steps:
          - checkout: self
            fetchDepth: 1

          - template: templates/setup-bun.yml

          - script: |
              export BUN_INSTALL="$HOME/.bun"
              export PATH="$BUN_INSTALL/bin:$PATH"
              bun run lint
            displayName: 'Run ESLint'
            continueOnError: true # TODO: Fix lint errors and remove this

      # Job 2: Unit Tests (runs in parallel)
      - job: UnitTest
        displayName: 'Unit Tests'
        pool: macos
        steps:
          - checkout: self
            fetchDepth: 1

          - template: templates/setup-bun.yml

          - script: |
              export BUN_INSTALL="$HOME/.bun"
              export PATH="$BUN_INSTALL/bin:$PATH"
              bun run test
            displayName: 'Run Tests'
            continueOnError: true # TODO: Fix test failures and remove this

      # Job 3: Terraform Plan (if terraform changed)
      - job: TerraformPlan
        displayName: 'Terraform Plan'
        pool: macos
        condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
        steps:
          - checkout: self
            fetchDepth: 0

          - script: |
              # Check if terraform files changed
              git diff --name-only origin/main...HEAD | grep -q "^terraform/" || exit 0
              echo "##vso[task.setvariable variable=terraformChanged]true"
            displayName: 'Check Terraform Changes'

          - task: AzureCLI@2
            displayName: 'Run Terraform Plan'
            condition: eq(variables['terraformChanged'], 'true')
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Install OpenTofu
                curl -fsSL https://get.opentofu.org/install-opentofu.sh | sh -s -- --install-method standalone

                cd terraform/environments/dev
                tofu init -input=false
                tofu plan -no-color -input=false 2>&1 | tee plan_output.txt

                # Post plan to PR comment via Azure DevOps API
                if [ -n "$SYSTEM_PULLREQUEST_PULLREQUESTID" ]; then
                  chmod +x ../../../scripts/terraform-plan-comment.sh
                  ../../../scripts/terraform-plan-comment.sh plan_output.txt
                fi

  # ========== BUILD (Main branch only) ==========
  - stage: Build
    displayName: 'Build & Push'
    dependsOn: Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DockerBuild
        displayName: 'Docker Build & Push'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          matrix:
            web:
              serviceName: 'web'
              dockerfilePath: 'apps/web/Dockerfile'
            upload-service:
              serviceName: 'upload-service'
              dockerfilePath: 'apps/upload-service/Dockerfile'
            processor-service:
              serviceName: 'processor-service'
              dockerfilePath: 'apps/processor-service/Dockerfile'
            ai-analyzer-service:
              serviceName: 'ai-analyzer-service'
              dockerfilePath: 'apps/ai-analyzer-service/Dockerfile'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: AzureCLI@2
            displayName: 'Build and Push $(serviceName)'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az acr login --name $(acrName)

                docker build \
                  -t $(acrLoginServer)/$(serviceName):$(Build.BuildId) \
                  -t $(acrLoginServer)/$(serviceName):latest \
                  -f $(dockerfilePath) \
                  .

                docker push $(acrLoginServer)/$(serviceName):$(Build.BuildId)
                docker push $(acrLoginServer)/$(serviceName):latest

  # ========== DEPLOY PREVIEW (Feature/Bugfix branches) ==========
  - stage: DeployPreview
    displayName: 'Deploy Preview Environment'
    dependsOn: Test
    condition: |
      and(
        succeeded(),
        or(
          startsWith(variables['Build.SourceBranch'], 'refs/heads/feature/'),
          startsWith(variables['Build.SourceBranch'], 'refs/heads/bugfix/')
        )
      )
    jobs:
      - job: BuildAndDeployPreview
        displayName: 'Build & Deploy Preview'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            persistCredentials: true
            fetchDepth: 1

          # Build all services with preview tag
          - task: AzureCLI@2
            displayName: 'Build and Push Preview Images'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                SHORT_SHA=$(echo $(Build.SourceVersion) | cut -c1-7)
                echo "Short SHA: $SHORT_SHA"
                echo "##vso[task.setvariable variable=shortSha;isOutput=true]$SHORT_SHA"

                az acr login --name $(acrName)

                # Build all 4 services
                for service in web upload-service processor-service ai-analyzer-service; do
                  echo "Building $service..."
                  docker build \
                    -t $(acrLoginServer)/${service}:preview-$SHORT_SHA \
                    -f apps/${service}/Dockerfile \
                    .
                  docker push $(acrLoginServer)/${service}:preview-$SHORT_SHA
                done

          # Generate preview manifests and commit to main
          - script: |
              set -e

              SHORT_SHA=$(echo $(Build.SourceVersion) | cut -c1-7)
              echo "Creating preview manifests for SHA: $SHORT_SHA"

              git config user.email "azure-pipelines@slingshotgrp.com"
              git config user.name "Azure Pipelines"

              # Preserve scripts and templates from the feature branch
              TEMP_TOOLS=$(mktemp -d)
              cp scripts/generate-preview.sh "$TEMP_TOOLS/" 2>/dev/null || true
              mkdir -p "$TEMP_TOOLS/templates"
              cp -r manifests/templates/preview "$TEMP_TOOLS/templates/" 2>/dev/null || true

              # Ensure we're on main branch
              git fetch origin
              git checkout -B main origin/main

              # Restore scripts and templates to workspace
              mkdir -p scripts
              mkdir -p manifests/templates
              cp "$TEMP_TOOLS/generate-preview.sh" scripts/ 2>/dev/null || true
              cp -r "$TEMP_TOOLS/templates/preview" manifests/templates/ 2>/dev/null || true

              # Generate manifests using the script
              chmod +x scripts/generate-preview.sh
              ./scripts/generate-preview.sh "$SHORT_SHA" "preview-$SHORT_SHA"

              # Add, commit, and push to main
              git add manifests/previews/$SHORT_SHA manifests/previews/kustomization.yaml
              git commit -m "chore(preview): create preview environment for $SHORT_SHA [skip ci]"
              git push origin main

              echo "Preview environment created at: https://preview-$SHORT_SHA.slingshotgrp.com"
            displayName: 'Create Preview Manifests (GitOps)'

  # ========== DEPLOY TO DEV (Main branch, GitOps) ==========
  - stage: DeployDev
    displayName: 'Deploy to Dev'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToDev
        displayName: 'Deploy to Dev Environment'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  persistCredentials: true
                - script: |
                    set -e

                    git config user.email "azure-pipelines@slingshotgrp.com"
                    git config user.name "Azure Pipelines"

                    git fetch origin
                    git checkout -B main origin/main

                    # Update image tags in dev kustomization
                    cd manifests/dev
                    for service in web upload-service processor-service ai-analyzer-service; do
                      sed -i "s|image: .*/\${service}:.*|image: $(acrLoginServer)/${service}:$(Build.BuildId)|g" ${service}-deployment.yaml
                    done

                    git add .
                    git commit -m "chore(dev): update images to $(Build.BuildId) [skip ci]"
                    git push origin main
                  displayName: 'Update Dev Image Tags (GitOps)'
